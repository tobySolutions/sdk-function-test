import { createBuildOptions, initFreePortCarousel, prepareMockDatabase, serveOptions } from '@fleek-platform/tester';
import { serve } from 'esbuild';

export default async () => {
  await prepareMockDatabase();

  await initFreePortCarousel({ portRange: [3100, 3300] });

  console.log('Starting local server...');

  const buildOptions = createBuildOptions({
    platform: 'browser',
    defined: {
      SDK__AUTH_APPS_URL: 'Not used',
      SDK__IPFS__STORAGE_API_URL: 'Inject value before related test',
      SDK__GRAPHQL_API_URL: 'Inject value before each test',
    },
    outdir: 'www',
  });
  const { stop } = await serve(serveOptions, buildOptions);

  return async () => {
    console.log('Stopping local server...');

    stop();
  };
};
